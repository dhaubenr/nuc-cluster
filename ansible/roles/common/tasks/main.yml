---

# named provisioning block - installs and configures all required packages
# run as 'root' via ansible's 'become' directive
# must be called with option '--ask-become-pass'
- name: configure apt source repositories
  block:
    - name: add source apt repositories (Linux Mint)
      copy:
        src: '{{ role_path }}/files/official-source-repositories.list'
        dest: /etc/apt/sources.list.d/official-source-repositories.list
        owner: root
        group: root
        mode: '0644'
      when: ansible_distribution == 'Linux Mint'

    - name: enable source apt repositories (Ubuntu)
      replace:
        path: /etc/apt/sources.list
        regexp: '^#(.*deb-src.*)'
        replace: '\1'
        backup: yes
      when: ansible_distribution == 'Ubuntu'

    - name: install basic packages
      apt:
        pkg:
        - cpu-checker
        - curl
        - ebtables
        - git
        - net-tools
        - nmap
        - wget
        - xfsprogs
        - zsh
        - zsh-doc
        update_cache: yes
        state: present
  become: yes

# named provisioning block - sets default environment variables
# run as 'root' via ansible's 'become' directive
# must be called with option '--ask-become-pass'
- name:
  block:
    - name: set LANG
      lineinfile:
        dest: /etc/environment
        regexp: '^LANG'
        line: 'LANG="en_US.UTF-8"'
        state: present

    - name: set LC_ALL
      lineinfile:
        dest: /etc/environment
        regexp: '^LC_ALL'
        line: 'LC_ALL="en_US.UTF-8"'
        state: present

    - name: set EDITOR
      lineinfile:
        dest: /etc/environment
        regexp: '^EDITOR'
        line: 'EDITOR=vi'
        state: present
  become: yes

# named provisioning block - configures the host's secondary ip address
# run as 'root' via ansible's 'become' directive
# must be called with option '--ask-become-pass'
- name: add secondary (static) ip address
  block:
    - name: configure network manager (Linux Mint)
      block:
        - name: get wired connection name
          shell: |
            nmcli c | grep {{ eth0_device_name }} | awk '{print $4}'
          register: wired_conn

        - name: add secondary ip address
          command: |
            nmcli c modify {{ wired_conn.stdout }} ipv4.addresses "{{ secondary_ip_prefix }}{{ host_index }}/24"
      when: ansible_distribution == 'Linux Mint'
      become: yes

    # handlers will always be triggered by setting the 'changed' condition
    # of the task to 'true'
    - name: configure netplan (Ubuntu)
      block:
        - name: create additional netplan interface configuration file
          template:
            src: '{{ role_path }}/templates/02-static.yaml.j2'
            dest: /etc/netplan/02-static.yaml
            backup: no
            mode: '0644'
          changed_when: true
          notify:
           - apply netplan configuration
      when: ansible_distribution == 'Ubuntu'
      become: yes
  become: yes

# named provisioning block - installs and configures xrdp
# run as 'root' via ansible's 'become' directive
# must be called with option '--ask-become-pass'
- name: add xrdp capabilities
  block:

    # handlers will always be triggered by setting the 'changed' condition
    # of the task to 'true'
    - name: install xrdp packages and register xrdp service
      apt:
        pkg:
        - xorgxrdp
        - xorg-video-abi-23
        - xrdp
        - xserver-xorg-core
        - xserver-xorg-video-intel
        update_cache: yes
        state: present
      changed_when: true
      notify:
        - enable xrdp

    - name: add xrdp user to ssl-cert group
      user:
        name: xrdp
        groups: ssl-cert
        append: yes
        state: present
  when: ansible_distribution == 'Linux Mint'
  become: yes

# named provisioning block - upgrade distribution
# run as 'root' via ansible's 'become' directive
# must be called with option '--ask-become-pass'
- name: upgrade distribution to latest release
  block:
    - name: run apt-install dist-upgrade
      apt:
        update_cache: yes
        upgrade: dist
  become: yes
